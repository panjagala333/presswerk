# SPDX-License-Identifier: PMPL-1.0-or-later
# Presswerk â€” Security scanning (cargo-audit, strict clippy, unwrap detection)

name: Security Scan

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1"

permissions: read-all

jobs:
  cargo-audit:
    name: Cargo Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        run: cargo audit

  clippy-strict:
    name: Clippy (Strict / Library Crates)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libxdo-dev libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev

      - name: Clippy pedantic (library crates)
        run: |
          cargo clippy \
            -p presswerk-core \
            -p presswerk-security \
            -p presswerk-document \
            -p presswerk-print \
            -- -D warnings -W clippy::pedantic

  panic-check:
    name: Panic Surface Check (Informational)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Count unwrap/expect usage outside tests
        run: |
          echo "=== Scanning for unwrap()/expect() in crates/ ==="
          echo "(Excluding #[cfg(test)] and mod tests blocks)"
          echo ""
          count=0
          while IFS= read -r file; do
            results=$(awk '
              /^[[:space:]]*#\[cfg\(test\)\]/ { skip=1; next }
              /^[[:space:]]*mod tests/ { skip=1; brace=0; next }
              skip && /{/ { brace++ }
              skip && /}/ { brace--; if (brace<=0) skip=0; next }
              skip { next }
              /\.unwrap\(\)|\.expect\(/ { print FILENAME ":" NR ": " $0 }
            ' "$file")
            if [ -n "$results" ]; then
              echo "$results"
              file_count=$(echo "$results" | wc -l)
              count=$((count + file_count))
            fi
          done < <(find crates/ -name '*.rs' -type f)
          echo ""
          echo "=== Total unwrap()/expect() calls outside test code: $count ==="
          if [ "$count" -gt 0 ]; then
            echo "::notice::Found $count unwrap()/expect() calls outside test code."
          else
            echo "::notice::No unwrap()/expect() calls found outside test code."
          fi
          exit 0
